{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <!-- Популярные категории -->
    <section class="mb-5">
        <h2 class="text-center mb-4">Shop by Category</h2>
        <div class="row justify-content-center">
            {% for category in categories|slice:":6" %}
                <div class="col-6 col-md-4 col-lg-2 mb-4">
                    <a href="{% url 'category_detail_view' category.id %}" class="text-decoration-none">
                        <div class="card h-100 border-0 shadow-sm text-center">
                            <div class="card-body">
                                {% if category.image %}
                                    <img src="{{ category.image.url }}" alt="{{ category.name }}" class="img-fluid mb-3" style="max-height: 80px;">
                                {% else %}
                                    <i class="fas fa-folder fa-3x mb-3 text-primary"></i>
                                {% endif %}
                                <h6 class="card-title">{{ category.name }}</h6>
                            </div>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </section>

    <!-- Все товары -->
    <section class="mb-5">
        <h2 class="text-center mb-4">Our Products</h2>
        <div class="row">
            {% for product in products %}
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-0 shadow-sm">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="fas fa-image fa-3x text-secondary"></i>
                            </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="card-text text-muted small">{{ product.description|truncatechars:50 }}</p>
                            <p class="card-text"><strong>${{ product.price }}</strong></p>
                        </div>
                        <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                            <a href="{% url 'product_detail_view' product.id %}" class="btn btn-outline-primary btn-sm flex-grow-1 me-2">View Details</a>
                            <form class="add-to-cart-form flex-grow-1" data-product-id="{{ product.id }}">
                                {% csrf_token %}
                                <button type="button" class="btn btn-primary btn-sm w-100 add-to-cart-btn" onclick="addToCart({{ product.id }})">
                                    <i class="fas fa-cart-plus"></i> Add to Cart
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <p class="text-center">No products available at the moment.</p>
                </div>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script>
function addToCart(productId) {
    fetch(`/add-to-cart/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({quantity: 1})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Product added to cart successfully!');
            const cartCounter = document.getElementById('cart-counter');
            if (cartCounter) {
                cartCounter.textContent = data.cart_count;
            }
        } else {
            throw new Error(data.error || 'Failed to add product to cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}
</script>
{% endblock %}