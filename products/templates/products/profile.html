{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* ... (ваши существующие стили) ... */
    .profile-picture {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 50%;
    }
    .profile-picture-container {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        position: relative;
        overflow: hidden;
        border-radius: 50%;
    }
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.3);
        border-radius: 50%;
        border-top-color: #000;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { -webkit-transform: rotate(360deg); }
    }
    @-webkit-keyframes spin {
        to { -webkit-transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-picture-container">
                {% if profile.avatar %}
                    <img src="{{ profile.avatar.url }}" alt="Profile Picture" class="profile-picture" id="profile-picture">
                {% else %}
                    <img src="{% static 'images/default.png' %}" alt="Default Avatar" class="profile-picture" id="profile-picture">
                {% endif %}
            </div>
            <h2 class="mb-3"><i class="fas fa-user-circle"></i> {{ user.username }}'s Profile</h2>
            <p class="text-muted">Member since {{ user.date_joined|date:"F d, Y" }}</p>
            {% if user.is_superuser %}
                <p class="badge bg-danger">Administrator</p>
            {% endif %}
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="profile-section">
                    <h3><i class="fas fa-edit"></i> Edit Profile</h3>
                    <form method="post" enctype="multipart/form-data" id="profile-form">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <div class="mb-3">
                            <label for="avatar-upload" class="form-label">Profile Picture</label>
                            <input type="file" name="avatar" id="avatar-upload" accept="image/*">
                            <small id="file-name" class="form-text text-muted"></small>
                            <img id="preview-image" src="#" alt="Preview" style="display: none;">
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                    <p id="upload-status"></p>
                    <div id="loading-indicator" class="loading" style="display: none;"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="profile-section">
                    <h3><i class="fas fa-shopping-bag"></i> Order History</h3>
                    {% if orders %}
                        <ul class="list-group">
                            {% for order in orders %}
                                <li class="list-group-item">
                                    Order #{{ order.id }} - {{ order.created_at|date:"F d, Y" }}
                                    <span class="badge bg-primary float-end">{{ order.get_total_cost }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No orders yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if user.is_superuser %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="profile-section">
                    <h3><i class="fas fa-cogs"></i> Admin Functions</h3>
                    <a href="{% url 'admin:index' %}" class="btn btn-warning">Go to Admin Panel</a>
                    <a href="{% url 'add_product' %}" class="btn btn-info">Add New Product</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('avatar-upload').addEventListener('change', function(event) {
    var file = event.target.files[0];
    var fileName = document.getElementById('file-name');
    var previewImage = document.getElementById('preview-image');
    var profilePicture = document.getElementById('profile-picture');
    
    if (file) {
        fileName.textContent = 'Selected file: ' + file.name;
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                
                var size = Math.min(img.width, img.height);
                var x = (img.width - size) / 2;
                var y = (img.height - size) / 2;
                
                ctx.drawImage(img, x, y, size, size, 0, 0, 200, 200);
                
                previewImage.src = canvas.toDataURL('image/jpeg');
                previewImage.style.display = 'block';
                profilePicture.src = canvas.toDataURL('image/jpeg');
            }
            img.onerror = function() {
                console.error('Error loading image');
                fileName.textContent = 'Error loading image';
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    } else {
        fileName.textContent = '';
        previewImage.style.display = 'none';
    }
});

document.getElementById('profile-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    var uploadStatus = document.getElementById('upload-status');
    var profilePicture = document.getElementById('profile-picture');
    var loadingIndicator = document.getElementById('loading-indicator');
    
    uploadStatus.textContent = 'Saving changes...';
    loadingIndicator.style.display = 'inline-block';
    
    fetch('{% url "profile" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            uploadStatus.textContent = 'Changes saved successfully!';
            if (data.avatar_url) {
                profilePicture.src = data.avatar_url;
            }
        } else {
            uploadStatus.textContent = 'Failed to save changes: ' + (data.error || 'Unknown error');
        }
    })
    .catch(error => {
        uploadStatus.textContent = 'An error occurred while saving changes.';
        console.error('Error:', error);
    })
    .finally(() => {
        loadingIndicator.style.display = 'none';
    });
});
</script>
{% endblock %}